---
title: "Face Attractiveness and the Sense of Reality"
author: "Dominique Makowski et al."
output:
  html_document:
    toc: true
    toc_depth: 2
    theme: paper
    code_folding: hide
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
---

```{r, echo = FALSE, warning=FALSE, message=FALSE}
options(
  digits = 3,
  mc.cores = 4,
  brms.algorithm = "sampling",
  brms.backend = "cmdstanr"
)

cache <- TRUE
runModels <- FALSE
bestModels <- FALSE
fig.width <- see::golden_ratio(7)
fig.height <- 7

knitr::opts_chunk$set(
  collapse = TRUE,
  dpi = 450,
  fig.path = "./figures/",
  fig.width = fig.width,
  fig.height = fig.height
)
```

# Methods

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggdist)
library(ggside)
library(easystats)
library(patchwork)
library(brms)
library(psych) # reliability analysis

set.seed(33)

df <- read.csv("data/data.csv") |>
  mutate(
    Date = lubridate::dmy(Date),
    Participant = fct_reorder(Participant, Date),
    Screen_Refresh = as.character(Screen_Refresh),
    Education = fct_relevel(Education, "Doctorate", "Master", "Bachelor", "High School", "Other", "Prefer not to Say"),
    Belief = fct_relevel(Belief, "Fake", "Real"),
    Stimulus_Interest = case_when(
      Sexual_Orientation == "Heterosexual" & Stimulus_SameSex == "Opposite" ~ TRUE,
      Sexual_Orientation == "Heterosexual" & Stimulus_SameSex == "Same" ~ FALSE,
      Sexual_Orientation == "Homosexual" & Stimulus_SameSex == "Opposite" ~ FALSE,
      Sexual_Orientation == "Homosexual" & Stimulus_SameSex == "Same" ~ TRUE,
      Sexual_Orientation %in% c("Bisexual", "Queer", "Pansexual") ~ TRUE,
      TRUE ~ NA
    )
  )


# head(df[is.na(df$Stimulus_Attract), ])

# Create individual scores for Simulation Monitoring
df <- df |>
  group_by(Participant, Belief) |>
  summarise(
    Confidence = mean(abs(Belief_Confidence)),
    n = n() / 109
  ) |>
  pivot_wider(names_from = "Belief", values_from = c("Confidence", "n")) |>
  ungroup() |>
  merge(df, by = "Participant")
```

## Exclusions {.tabset}

```{r message=FALSE, warning=FALSE}
outliers <- c(
  # More than 2 attention check fails
  "S113",
  "S049",
  # Very short duration for questionnaire + low rating correlations (< 0.1)
  "S035",
  "S117",
  # Preferred not answering to sexual orientation: further analysis impossible
  "S101"
)
outliers_partial <- c(
  # 1 attention check failed
  "S027",
  "S017",
  "S097",
  "S006",
  "S055",
  "S033"
)
```

We removed `r length(outliers)` participants based on failed attention checks.

### Extreme Items

```{r message=FALSE, warning=FALSE, cache=cache}
extreme_items <- df |>
  group_by(Stimulus, Belief) |>
  summarize(n = n() / length(unique(df$Participant)), .groups = "keep") |>
  pivot_wider(values_from = "n", names_from = "Belief") |>
  mutate(File = paste0("experiment/stimuli/AMFD/", Stimulus)) |>
  arrange(Real) |>
  filter(Real < 0.2 | Real > 0.8) |> 
  ungroup() |> 
  mutate(Belief_Answer = c(-0.2, 0, 0, 0.2))


p_item <- df |>
  group_by(Stimulus) |> 
  mutate(Average_belief = mean(Belief_Answer)) |> 
  ungroup() |> 
  mutate(Stimulus = fct_reorder(Stimulus, Average_belief)) |>
  # filter(Stimulus %in% extreme_items$Stimulus) |>
  ggplot(aes(x = Belief_Answer, y = Stimulus, fill = Stimulus)) +
  ggdist::stat_slab(scale = 4, slab_alpha = 2/3, normalize = "groups", color = "black", size=0.2) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  ggimage::geom_image(data = extreme_items, aes(image = File, y = Stimulus), position = position_jitter(width = 0.2), size = 0.05, by = "height") +
  scale_y_discrete(expand = c(0.1, 0.1)) +
  scale_x_continuous(
    limits = c(-1, 1),
    expand = c(0, 0),
    breaks = c(-0.95, 0, 0.95),
    label = c("Fake", "", "Real")
  ) +
  scale_fill_viridis_d(option = "inferno") +
  labs(x = "Simulation Monitoring", y = "Items", title = "Distribution of Reality Judgments") +
  guides(fill = "none") +
  see::theme_modern() +
  theme(
    axis.text.y = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
p_item

extreme_items

# df <- df |>
#   filter(!Stimulus %in% extreme_items$Stimulus)
```

We removed `r nrow(extreme_items)` trials per participant.

### Attention Checks and Duration

```{r message=FALSE, warning=FALSE}
dfsub <- df |>
  group_by(Participant) |>
  select(Participant, starts_with("Attention"), starts_with("Duration"), n_Fake) |>
  slice(1) |>
  ungroup() |>
  rowwise() |>
  mutate(Attention_Check = mean(c(Attention_Check1, Attention_Check2, Attention_Check3))) |>
  ungroup() |>
  arrange(Attention_Check)
```

### Ratings

```{r message=FALSE, warning=FALSE}
dfsub$r_Trustworthy <- NA
dfsub$r_Attractive <- NA
dfsub$r_Beauty <- NA
for (participant in dfsub$Participant) {
  dfsub[dfsub$Participant == participant, "r_Trustworthy"] <- cor(df[df$Participant == participant, "Trustworthy"], df[df$Participant == participant, "Norms_Trustworthy"])
  dfsub[dfsub$Participant == participant, "r_Attractive"] <- cor(df[df$Participant == participant, "Attractive"], df[df$Participant == participant, "Norms_Attractive"])
  dfsub[dfsub$Participant == participant, "r_Beauty"] <- cor(df[df$Participant == participant, "Beauty"], df[df$Participant == participant, "Norms_Attractive"])
}
```

### Summary

```{r message=FALSE, warning=FALSE}
data.frame(Participant = c(paste0("Total (n=", nrow(dfsub), ")")), t(sapply(dfsub[2:ncol(dfsub)], mean, na.rm = TRUE))) |>
  rbind(dfsub) |>
  mutate(Attention_Check = paste0(
    insight::format_value(Attention_Check, 1),
    " (", insight::format_value(Attention_Check1, 1),
    ", ",
    insight::format_value(Attention_Check2, 1),
    ", ",
    insight::format_value(Attention_Check3, 1),
    ")"
  )) |>
  select(-Attention_Check1, -Attention_Check2, -Attention_Check3) |>
  datawizard::data_relocate("Attention_Check", 2) |>
  knitr::kable() |>
  kableExtra::row_spec(1, italic = TRUE) |>
  kableExtra::row_spec(which(dfsub$Participant %in% outliers) + 1, background = "#EF9A9A") |>
  kableExtra::row_spec(which(dfsub$Participant %in% outliers_partial) + 1, background = "#FFCC80")  |> 
  kableExtra::kable_styling(full_width = TRUE) |> 
  kableExtra::scroll_box(width = "100%", height = "500px")
# kableExtra::row_spec(which(str_detect(dfsub$Participant, "613a972033d79df11a6570de")) + 1, background = "green")
```

```{r message=FALSE, warning=FALSE, cache=cache, fig.width=20, fig.height=20}
p_att <- dfsub |>
  select(Participant, starts_with("Att")) |>
  pivot_longer(-Participant) |>
  # mutate(name = str_remove(name, "Cor_")) |>
  ggplot(aes(x = Participant, y = value)) +
  geom_bar(aes(fill = name), stat = "identity", position = "dodge") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("black", "#2196F3", "#3F51B5", "#673AB7")) +
  scale_color_manual(values = c("black", "#2196F3", "#3F51B5", "#673AB7")) +
  see::theme_modern() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "top"
  ) +
  labs(y = "Score", fill = "") +
  guides(color = "none") +
  ggside::geom_ysidedensity(aes(x = after_stat(scaled), color = name)) +
  ggside::theme_ggside_void() +
  ggside::scale_ysidex_continuous(expand = c(0, 0))

p_time <- dfsub |>
  select(Participant, starts_with("Duration")) |>
  pivot_longer(-Participant) |>
  mutate(name = str_remove(name, "Duration_")) |>
  ggplot(aes(x = Participant, y = value)) +
  geom_bar(aes(fill = name), stat = "identity", position = "dodge") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("#4CAF50", "#FF9800")) +
  scale_color_manual(values = c("#4CAF50", "#FF9800")) +
  see::theme_modern() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "top"
  ) +
  labs(y = "Duration (min)", fill = "") +
  guides(color = "none") +
  ggside::geom_ysidedensity(aes(x = after_stat(scaled), color = name)) +
  ggside::theme_ggside_void() +
  ggside::scale_ysidex_continuous(expand = c(0, 0))

p_cor <- dfsub |>
  select(Participant, starts_with("r_")) |>
  pivot_longer(-Participant) |>
  mutate(name = str_remove(name, "r_")) |>
  ggplot(aes(x = Participant, y = value)) +
  geom_bar(aes(fill = name), stat = "identity", position = "dodge") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("#F44336", "#9C27B0", "#5227b0")) +
  scale_color_manual(values = c("#F44336", "#9C27B0", "#5227b0")) +
  see::theme_modern() +
  theme(
    axis.text.x = element_text(
      angle = 45, hjust = 1,
      color = ifelse(levels(dfsub$Participant) %in% outliers, "red", ifelse(levels(dfsub$Participant) %in% outliers_partial, "orange", "black"))
    ),
    legend.position = "top"
  ) +
  labs(y = "Correlation", fill = "") +
  guides(color = "none") +
  ggside::geom_ysidedensity(aes(x = after_stat(scaled), color = name)) +
  ggside::theme_ggside_void() +
  ggside::scale_ysidex_continuous(expand = c(0, 0))

(p_att + theme(axis.text.x = element_blank())) /
  (p_time + theme(axis.text.x = element_blank())) /
  (p_cor)

df <- df |>
  filter(!Participant %in% c(outliers))
```

## Participants

```{r message=FALSE, warning=FALSE}
dfsub <- df |>
  group_by(Participant) |>
  select(Participant, Age, Sex, Sexual_Orientation, Ethnicity, Education, Nationality, Device_OS, starts_with("Screen"), starts_with("IPIP"), starts_with("Social_"), starts_with("FFNI_"), starts_with("GPTS_"), starts_with("IUS_"), starts_with("SelfAttractiveness"), starts_with("AI"), n_Real, Confidence_Fake, Confidence_Real) |>
  slice(1) |>
  ungroup()
```

The final sample included `r report::report_participants(dfsub, age="Age", sex="Sex")`.

```{r }
plot_distribution <- function(dfsub, what = "Age", title = what, subtitle = "", fill = "orange") {
  dfsub |>
    ggplot(aes_string(x = what)) +
    geom_density(fill = fill) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    ggtitle(title, subtitle = subtitle) +
    theme_modern() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(face = "italic", hjust = 0.5),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      axis.text.y = element_blank()
    )
}

plot_waffle <- function(dfsub, what = "Nationality", title = what, rows = 7, size = 6) {
  # library(emojifont)
  ggwaffle::waffle_iron(dfsub, what, rows = rows) |>
    # mutate(label = emojifont::fontawesome('fa-smiley')) |>
    # mutate(label = emojifont::emoji('smiley')) |>
    ggplot(aes(x, y)) +
    geom_point(aes(color = group), shape = "square", size = size) +
    # ggwaffle::geom_waffle(color = "white") +
    # geom_point() +
    # geom_text(aes(color=group ,label=label), family='fontawesome-webfont', size=4) +
    # geom_text(aes(color=group ,label=label), family='EmojiOne', size=4) +
    coord_equal() +
    ggtitle(title) +
    labs(fill = "", color = "") +
    # scale_x_continuous(expand = c(0, 0)) +
    # scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
    # ggwaffle::theme_waffle() +
    theme(plot.title = element_text(face = "bold", hjust = 0.5))
}
```

```{r fig.width=20, fig.height=15}
p1 <- estimate_density(dfsub$Age) |>
  ggplot(aes(x = x, y = y)) +
  geom_area(fill = "#FF9800") +
  labs(x = "Age", y = "") +
  theme_modern()

p2 <- plot_waffle(dfsub, "Sex") +
  scale_color_manual(values = c("Male" = "#2196F3", "Female" = "#E91E63", "Other" = "#FF9800"))

p3 <- plot_waffle(dfsub, "Sexual_Orientation")


p4 <- plot_waffle(dfsub, "Education") +
  scale_fill_viridis_d()

p5 <- dfsub |>
  group_by(Nationality) |>
  mutate(n = n()) |>
  ungroup() |>
  mutate(Nationality = fct_reorder(Nationality, desc(n))) |>
  ggplot(aes(Nationality)) +
  geom_bar(aes(fill = Nationality)) +
  scale_fill_viridis_d(guide = "none") + 
  theme_modern() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

p6 <- plot_waffle(dfsub, "Ethnicity") +
  scale_fill_manual(values = c("Latino" = "#FF5722", "Asian" = "#FF9800", "Caucasian" = "#2196F3", "African" = "#4CAF50", "Jewish" = "#9C27B0", "Mixed" = "#795548"))

p7 <- plot_waffle(dfsub, "Screen_Resolution", title = "Screen Resolution") +
  scale_fill_pizza_d() +
  guides(fill = "none")

p8 <- plot_waffle(dfsub, "Device_OS", title = "Device OS") +
  scale_fill_bluebrown_d()

# p10 <- plot_waffle(dfsub, "Screen_Refresh") +
#   scale_fill_viridis_d()

patchwork::wrap_plots(list(p1, p2, p3, p5, p4, p6))
```

## Scales - Reliability analysis {.tabset}

### IPIP

```{r}
#extraversion
dplyr::select(df, starts_with("Extraversion_")) |>
psych::alpha(check.keys = TRUE) # 0.82

#Conscientiousness
dplyr::select(df, starts_with("Conscientiousness_")) |>
psych::alpha(check.keys = TRUE) # 0.73

#Neuroticism 
dplyr::select(df, starts_with("Neuroticism_")) |>
psych::alpha(check.keys = TRUE) # 0.59

#Openness
dplyr::select(df, starts_with("Conscientiousness_")) |>
psych::alpha(check.keys = TRUE) # 0.73

#Honest-Humility
dplyr::select(df, starts_with("HonestyHumility_")) |>
psych::alpha(check.keys = TRUE) # 0.7

#Agreableness 
dplyr::select(df, starts_with("Agreeableness_")) |>
psych::alpha(check.keys = TRUE) # 0.82


```

### SIAS-6 and SPS-6

```{r}
#SIAS- social interaction scale
dplyr::select(df, starts_with("SIAS_")) |>
psych::alpha(check.keys = TRUE) # 0.84


#SPS - social phobia scale
dplyr::select(df, starts_with("Social_Phobia_")) |>
psych::alpha(check.keys = TRUE) # 0.87

```

### Expectations about AI technology and GAAIS

<!-- Expectations about AI = items that did not said OG scale item from the parameters.js (GAAIS_1;3;5;7;10) -->

```{r}

#expectations about AI
dplyr::select(df, AI_1_RealisticImages, AI_3_VideosReal, AI_5_ImitatingReality, AI_7_RealisticVideos, AI_10_FaceErrors) |>
psych::alpha(check.keys = TRUE) # 0.61


#GAAIS
dplyr::select(df, AI_2_Unethical, AI_4_DailyLife, AI_6_Dangerous, AI_8_Exciting, AI_9_Applications) |>
psych::alpha(check.keys = TRUE) # 0.74

## positive GAAIS
dplyr::select(df, AI_4_DailyLife, AI_8_Exciting, AI_9_Applications) |>
psych::alpha(check.keys = TRUE) # 0.74

## negtavive GAAIS
dplyr::select(df, AI_2_Unethical, AI_6_Dangerous) |>
psych::alpha(check.keys = TRUE) # 0.74


```

### FFNI-BF

#### Low-order dimensions

```{r}

#acclaim seeking 
dplyr::select(df, Acclaim_Seeking_1, Acclaim_Seeking_16) |>
psych::alpha(check.keys = TRUE) # 0.68

#authoritativeness
dplyr::select(df, Authoritativeness_3, Authoritativeness_18) |>
psych::alpha(check.keys = TRUE) # 0.77

#grandiose fantasies
dplyr::select(df, Grandiose_Fantasies_8, Grandiose_Fantasies_23) |>
psych::alpha(check.keys = TRUE) # 0.8

#Exhibition 
dplyr::select(df, Exhibitionism_6, Exhibitionism_21) |>
psych::alpha(check.keys = TRUE) # 0.65

#Manipulativeness
dplyr::select(df, Manipulativeness_11, Manipulativeness_26) |>
psych::alpha(check.keys = TRUE) # 0.58

#Exploitativeness
dplyr::select(df, Exploitativeness_7, Exploitativeness_22) |>
psych::alpha(check.keys = TRUE) # 0.74

# Entitlement 
dplyr::select(df, Entitlement_5, Entitlement_20) |>
psych::alpha(check.keys = TRUE) # 0.8

#  Lack of empathy
dplyr::select(df, Lack_of_Empathy_10, Lack_of_Empathy_25) |>
psych::alpha(check.keys = TRUE) # 0.68

#Arrogance 
dplyr::select(df, Arrogance_2, Arrogance_17) |>
psych::alpha(check.keys = TRUE) # 0.59

# Reactive Anger
dplyr::select(df, Reactive_Anger_13, Reactive_Anger_28) |>
psych::alpha(check.keys = TRUE) # 0.66

# Distrut
dplyr::select(df, Distrust_19, Distrust_4) |>
psych::alpha(check.keys = TRUE) # 0.55

# Thrill Seeking 
dplyr::select(df, Thrill_Seeking_15, Thrill_Seeking_30) |>
psych::alpha(check.keys = TRUE) # 0.77

# Shame
dplyr::select(df, Shame_14, Shame_29) |>
psych::alpha(check.keys = TRUE) # 0.72

# Indifference 
dplyr::select(df, Indifference_9, Indifference_24) |>
psych::alpha(check.keys = TRUE) # 0.63

# Need for admiration
dplyr::select(df, Need_for_Admiration_12, Need_for_Admiration_27) |>
psych::alpha(check.keys = TRUE) # 0.57

```

#### High-order dimensions

```{r}

##agentic narcissism 

dplyr::select(df, Acclaim_Seeking_1, Acclaim_Seeking_16, Authoritativeness_3, Authoritativeness_18, Grandiose_Fantasies_8, Grandiose_Fantasies_23,  Exhibitionism_6, Exhibitionism_21) |>
psych::alpha(check.keys = TRUE) #0.78 

#Antognistic Narcissism 

dplyr::select(df, Manipulativeness_11, Manipulativeness_26, Exploitativeness_7, Exploitativeness_22, Entitlement_5, Entitlement_20, Lack_of_Empathy_10, Lack_of_Empathy_25, Arrogance_2, Arrogance_17, Reactive_Anger_13, Reactive_Anger_28, Distrust_19, Distrust_4, Thrill_Seeking_15, Thrill_Seeking_30) |>
psych::alpha(check.keys = TRUE) # 0.83

# Neurotic Narcissism

dplyr::select(df, Shame_14, Shame_29, Indifference_9, Indifference_24, Need_for_Admiration_12, Need_for_Admiration_27) |>
psych::alpha(check.keys = TRUE) # 0.79

```

### R-GPTS

```{r}
# Reference
dplyr::select(df, starts_with("Reference_")) |>
psych::alpha(check.keys = TRUE) # 0.85

#Prosecution 
dplyr::select(df, starts_with("Persecution_")) |>
psych::alpha(check.keys = TRUE) # 0.93

```

### IUS-12

```{r}

# Prospective anxiety 
dplyr::select(df, starts_with("Prospective_Anxiety_")) |>
psych::alpha(check.keys = TRUE) # 0.8

#Inhibitory anxiety
dplyr::select(df, starts_with("Inhibitory_Anxiety_")) |>
psych::alpha(check.keys = TRUE) # 0.82

```

### Sel-rated attractiveness

```{r}

dplyr::select(df, self_rated_general_attractiveness, self_rated_physical_attractiveness) |>
psych::alpha(check.keys = TRUE) # 0.94

```

:::

# Results

## Manipulation Check

### Real / Fake

```{r message=FALSE, warning=FALSE, fig.height=fig.width*1.5, cache=cache}
# plot(estimate_density(filter(df, Participant == "60dd7b03f1e72d38230df476_9yh9n")$Belief_Answer))
df |>
  mutate(Participant = fct_relevel(Participant, df |>
    group_by(Participant) |>
    summarize(Belief_Answer = mean(Belief_Answer)) |>
    ungroup() |>
    arrange(Belief_Answer) |>
    pull(Participant) |>
    as.character())) |>
  # mutate(Participant = fct_relevel(Participant, as.character(dfsub$Participant))) |>
  ggplot(aes(x = Belief_Answer, y = Participant, fill = Participant)) +
  ggdist::stat_slab(scale = 4, slab_alpha = 2/3, normalize = "groups", color = "black", size = 0.2) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  scale_y_discrete(expand = c(0.02, 0)) +
  scale_x_continuous(
    limits = c(-1, 1),
    expand = c(0, 0),
    breaks = c(-0.95, 0, 0.95),
    label = c("Fake", "", "Real")
  ) +
  scale_fill_viridis_d() +
  labs(x = "Simulation Monitoring", y = "Participants", title = "Distribution of Reality Judgments") +
  guides(fill = "none") +
  see::theme_modern() +
  theme(
    axis.text.y = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  ggside::geom_xsidedensity(fill = "grey", color = "white") +
  ggside::scale_xsidey_continuous(expand = c(0, 0))


df |> 
  group_by(Participant, Belief) |> 
  summarize(n = n() / 108, 
            Confidence = mean(Belief_Confidence)) |> 
  pivot_wider(values_from=c("n", "Confidence"), names_from="Belief") |> 
  ungroup() |> 
  describe_posterior(centrality = "mean", test=FALSE)


m <- glmmTMB::glmmTMB(Belief ~ 1 + (1|Participant) + (1|Stimulus), data=df, family="binomial")
icc(m, by_group = TRUE)
```

### Colinearity

```{r message=FALSE, warning=FALSE}
IVs <- c("Attractive", "Beauty", "Trustworthy", "Familiar")

correlation::correlation(df[IVs], partial=TRUE)
```

```{r message=FALSE, warning=FALSE, cache=cache}
preds <- data.frame()
dats <- data.frame()
for (x in IVs) {
  for (y in IVs) {
    if (x == y) next
    print(paste(y, "~", x))
    model <- glmmTMB::glmmTMB(as.formula(
      paste(y, "~", x, "* Sex * Stimulus_Interest + (1|Participant) + (1|Stimulus)")
    ),
    data = df,
    family = glmmTMB::beta_family()
    )

    # model <- mgcv::gamm(Real ~ s(Attractive) + Trustworthy,
    #                     random = list(Participant=~1, Stimulus=~1),
    #                     data = df,
    #                     family=mgcv::betar())

    pred <- estimate_relation(model, at = c(x, "Stimulus_Interest", "Sex"), length = 20)
    pred$y <- y
    pred <- data_rename(pred, x, "Score")
    pred$x <- x
    preds <- rbind(preds, pred)

    dats <- rbind(dats, data.frame(Score = df[[x]], Predicted = df[[y]], x = x, y = y, Sex = df$Sex))
  }
}

dats <- mutate(dats, x = fct_relevel(x, IVs), y = fct_relevel(y, IVs))
preds <- mutate(preds, x = fct_relevel(x, IVs), y = fct_relevel(y, IVs))
```

```{r message=FALSE, warning=FALSE, cache=cache}
dats |>
  ggplot(aes(x = Score, y = Predicted)) +
  stat_density_2d(aes(fill = after_stat(density)), geom = "raster", contour = FALSE) +
  # geom_ribbon(data = preds, aes(ymin = CI_low, ymax = CI_high, group = Stimulus_SameSex), alpha = 0.3) +
  geom_line(data = preds, aes(color = Sex, linetype = Stimulus_Interest)) +
  scale_fill_gradientn(colors = c("white", "#FF9800", "#F44336"), guide = "none") +
  scale_color_manual(values = c("Male" = "#2196F3", "Female" = "#E91E63")) +
  scale_linetype_manual(values = c("TRUE" = "solid", "FALSE" = "dashed")) +
  scale_x_continuous(expand = c(0, 0), labels = scales::percent) +
  scale_y_continuous(expand = c(0, 0), labels = scales::percent) +
  facet_grid(y ~ x, switch = "both") +
  theme_modern() +
  labs(title = "Collinearity in the Stimuli Ratings") +
  theme(
    aspect.ratio = 1,
    strip.background = element_blank(),
    strip.placement = "outside",
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  ggnewscale::new_scale_fill() +
  scale_fill_manual(values = c("Male" = "#2196F3", "Female" = "#E91E63")) +
  ggside::geom_xsidedensity(aes(fill = Sex), color = NA, alpha = 0.3) +
  ggside::geom_ysidedensity(aes(fill = Sex), color = NA, alpha = 0.3) +
  ggside::theme_ggside_void() +
  ggside::scale_ysidex_continuous(expand = c(0, 0)) +
  ggside::scale_xsidey_continuous(expand = c(0, 0)) +
  ggside::ggside(collapse = "all")
```

### Effect of Delay

```{r message=FALSE, warning=FALSE, cache=cache}
model <- glmmTMB::glmmTMB(Belief ~ Delay + (1 | Participant) + (1 | Stimulus),
  data = df,
  family = "binomial"
)
pred <- estimate_relation(model, at = "Delay", length = 20)

m_conf <- glmmTMB::glmmTMB(Belief_Confidence ~ Belief / Delay + ((Belief / Delay) | Participant) + (1 | Stimulus),
  data = df,
  family = glmmTMB::beta_family()
)
y_conf <- estimate_relation(m_conf, at = c("Delay", "Belief"), length = 20)
y_conf <- y_conf |>
  mutate_at(c("Predicted", "CI_low", "CI_high"), function(x) ifelse(y_conf$Belief == "Real", datawizard::rescale(x, range = c(0, 1), to = c(0.5, 1)), datawizard::rescale(x, range = c(1, 0), to = c(0, 0.5))))


df |>
  ggplot(aes(x = Delay, y = Real)) +
  stat_density_2d(aes(fill = after_stat(density)), geom = "raster", contour = FALSE) +
  geom_hline(yintercept = 0.5, linetype = "dotted") +
  # geom_ribbon(data=y_conf, aes(y=Predicted, ymin = CI_low, ymax = CI_high), alpha = 0.3) +
  geom_line(data = y_conf, aes(y = Predicted, group = Belief), linetype = "dashed", color = "red") +
  geom_ribbon(data = pred, aes(y = Predicted, ymin = CI_low, ymax = CI_high), alpha = 0.3) +
  geom_line(data = pred, aes(y = Predicted), color = "red") +
  scale_fill_gradientn(colors = c("white", "#795548"), guide = "none") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0), labels = scales::percent) +
  theme_modern() +
  labs(title = "Effect of Re-exposure Delay", x = "Minutes") +
  theme(
    aspect.ratio = 1,
    strip.background = element_blank(),
    strip.placement = "outside",
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  ggside::geom_xsidedensity(fill = "#795548", color = "white") +
  ggside::geom_ysidedensity(fill = "#9C27B0", color = "white") +
  ggside::theme_ggside_void() +
  ggside::scale_ysidex_continuous(expand = c(0, 0)) +
  ggside::scale_xsidey_continuous(expand = c(0, 0)) +
  ggside::ggside(collapse = "all")

hdi(df$Delay)
estimate_relation(model, at="Delay=c(0, 60)")

parameters::parameters(model, effects="fixed", exponentiate=TRUE) |> 
  display()
parameters::parameters(m_conf, effects="fixed") |> 
  display()
```

### Effect of Presentation Order

```{r message=FALSE, warning=FALSE, cache=cache}
model <- glmmTMB::glmmTMB(Belief ~ Block2_Trial + (1 | Participant) + (1 | Stimulus),
  data = df,
  family = "binomial"
)
pred <- estimate_relation(model, at = "Block2_Trial", length = 20)

m_conf <- glmmTMB::glmmTMB(Belief_Confidence ~ Belief / Block2_Trial + ((Belief / Block2_Trial) | Participant) + (1 | Stimulus),
  data = df,
  family = glmmTMB::beta_family()
)
y_conf <- estimate_relation(m_conf, at = c("Block2_Trial", "Belief"), length = 20)
y_conf <- y_conf |>
  mutate_at(c("Predicted", "CI_low", "CI_high"), function(x) ifelse(y_conf$Belief == "Real", datawizard::rescale(x, range = c(0, 1), to = c(0.5, 1)), datawizard::rescale(x, range = c(1, 0), to = c(0, 0.5))))


df |>
  ggplot(aes(x = Block2_Trial, y = Real)) +
  stat_density_2d(aes(fill = after_stat(density)), geom = "raster", contour = FALSE) +
  geom_hline(yintercept = 0.5, linetype = "dotted") +
  # geom_ribbon(data=y_conf, aes(y=Predicted, ymin = CI_low, ymax = CI_high), alpha = 0.3) +
  geom_line(data = y_conf, aes(y = Predicted, group = Belief), linetype = "dashed", color = "red") +
  geom_ribbon(data = pred, aes(y = Predicted, ymin = CI_low, ymax = CI_high), alpha = 0.3) +
  geom_line(data = pred, aes(y = Predicted), color = "red") +
  scale_fill_gradientn(colors = c("white", "#FF9800"), guide = "none") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0), labels = scales::percent) +
  theme_modern() +
  labs(title = "Effect of Presentation Order", x = "Minutes", y="Presentation Order") +
  theme(
    aspect.ratio = 1,
    strip.background = element_blank(),
    strip.placement = "outside",
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  ggside::geom_xsidedensity(fill = "#FF9800", color = "white") +
  ggside::geom_ysidedensity(fill = "#9C27B0", color = "white") +
  ggside::theme_ggside_void() +
  ggside::scale_ysidex_continuous(expand = c(0, 0)) +
  ggside::scale_xsidey_continuous(expand = c(0, 0)) +
  ggside::ggside(collapse = "all")


parameters::parameters(model, effects="fixed", exponentiate=TRUE) |> 
  display(digits=4)
parameters::parameters(m_conf, effects="fixed") |> 
  display(digits=6)
```

## Determinants of Reality {.tabset}

```{r message=FALSE, warning=FALSE}
make_model <- function(df, var = "Attractive", formula = var, fill = "#2196F3") {
  # Models
  m_real <- glmmTMB::glmmTMB(as.formula(paste0("Belief ~ ", formula)),
    data = df,
    family = "binomial"
  )
  y_real <- estimate_relation(m_real, at = c(var, "Sex"), length = 21)
  # gam <- brms::brm(paste0("Belief ~ s(", var, ", by=Sex) + (1|Participant) + (1|Stimulus)"),
  #                  data=df,
  #                  algorithm="sampling",
  #                  family = "bernoulli")
  # trend <- estimate_relation(gam, at = c(var, "Sex"), length = 81, preserve_range=FALSE)
  # slope <- estimate_slopes(gam, trend=var, at = c(var, "Sex"), length = 81)
  # trend$Trend <- interpret_pd(slope$pd)
  # trend$group <- 0
  # trend$group[2:nrow(trend)] <- as.character(cumsum(ifelse(trend$Trend[2:nrow(trend)] == trend$Trend[1:nrow(trend)-1], 0, 1)))


  m_conf <- glmmTMB::glmmTMB(as.formula(paste0("Belief_Confidence ~ Belief /", formula)),
    data = df,
    family = glmmTMB::beta_family()
  )
  y_conf <- estimate_relation(m_conf, at = c(var, "Belief", "Sex"), length = 21)
  y_conf <- y_conf |>
    mutate_at(c("Predicted", "CI_low", "CI_high"), function(x) ifelse(y_conf$Belief == "Real", datawizard::rescale(x, range = c(0, 1), to = c(0.5, 1)), datawizard::rescale(x, range = c(1, 0), to = c(0, 0.5))))

  # Significance
  sig1 <- data.frame(x = 0.5, 
                     y = y_real[c(11, 31), "Predicted"],
                     Sex = y_real[c(11, 31), "Sex"])
  param <- parameters::parameters(m_real, effects = "fixed", keep = var)
  sig1$p <- c(min(param[str_detect(param$Parameter, sig1$Sex[1]), "p"]), min(param[str_detect(param$Parameter, sig1$Sex[2]), "p"]))
  sig1$y <- sig1$y + ifelse(sig1$Sex == "Male", -0.03, 0.03)
  sig1$label <- ifelse(sig1$p > .05 & sig1$p < .099, format_p(sig1$p), format_p(sig1$p, stars_only = TRUE))
  
  sig2 <- data.frame(x = 0.5, 
                     y =  y_conf[c(11, 31, 51, 71), "Predicted"],
                     Sex = y_conf[c(11, 31, 51, 71), "Sex"],
                     Belief = y_conf[c(11, 31, 51, 71), "Belief"]) |> 
    arrange(Sex, Belief)
  param <- parameters::parameters(m_conf, effects = "fixed", keep = var) |> 
    arrange(Parameter)
  sig2$p <- c(min(param$p[c(1, 2)]), min(param$p[c(5, 6)]), min(param$p[c(3, 4)]), min(param$p[c(7, 8)]))
  sig2$y <- sig2$y + ifelse(sig2$Belief == "Real", 0.03, -0.03)
  sig2$label <- ifelse(sig2$p > .05 & sig2$p < .099, format_p(sig2$p), format_p(sig2$p, stars_only = TRUE))
  
  
  # Plot
  p <- df |>
    ggplot(aes(x = .data[[var]], y = .data[["Real"]])) +
    stat_density_2d(aes(fill = after_stat(density)), geom = "raster", contour = FALSE) +
    scale_fill_gradientn(colors = c("white", fill), guide = "none") +
    ggnewscale::new_scale_fill() +
    geom_hline(yintercept = 0.5, linetype = "dotted") +
    # geom_point2(alpha = 0.25, size = 4, color = "black") +
    geom_line(data = y_conf, aes(y = Predicted, group = interaction(Belief, Sex), color = Sex), linetype = "dashed") +
    geom_ribbon(data = y_real, aes(y = Predicted, group = Sex, fill = Sex, ymin = CI_low, ymax = CI_high), alpha = 1 / 3) +
    geom_line(data = y_real, aes(y = Predicted, color = Sex), linewidth=1) +
    # geom_ribbon(data = trend, aes(y = Predicted, group=Sex, fill=Sex, ymin = CI_low, ymax = CI_high), alpha = 1/6) +
    # geom_line(data = trend, aes(y = Predicted, color=Sex, linetype=Trend, group=interaction(Sex, group)), size=0.6) +
    geom_text(data = sig1, aes(y = y, x = x, label = label, color = Sex), size = ifelse(sig1$p < .05, 8.5, 3.5)) +
    geom_text(data = sig2, aes(y = y, x = x, label = label, color = Sex), size = ifelse(sig2$p < .05, 5, 3)) +
    scale_color_manual(values = c("Male" = "#2196F3", "Female" = "#E91E63")) +
    scale_fill_manual(values = c("Male" = "#2196F3", "Female" = "#E91E63")) +
    scale_x_continuous(expand = c(0, 0), labels = scales::percent) +
    scale_y_continuous(expand = c(0, 0), breaks = c(0, 0.25, 0.5, 0.75, 1), labels = c("Fake", "25%", "50%", "75%", "Real")) +
    labs(y = "Simulation Monitoring") +
    guides(fill = guide_legend(override.aes = list(alpha = 1))) +
    theme_modern(axis.title.space = 5) +
    ggside::geom_xsidedensity(aes(fill = Sex), alpha=2/3, color = NA) +
    ggside::geom_ysidedensity(aes(fill = Sex), alpha=2/3, color = NA) +
    ggside::theme_ggside_void() +
    ggside::scale_ysidex_continuous(expand = c(0, 0)) +
    ggside::scale_xsidey_continuous(expand = c(0, 0))

  list(p = p, model_belief = m_real, model_confidence = m_conf)
}
```

```{r make_models, fig.height=fig.width, fig.width=fig.width, message=FALSE, warning=FALSE, cache=FALSE}
rez_at <- make_model(filter(df, Stimulus_Interest == TRUE),
  formula = "Sex / poly(Attractive, 2) + (1|Participant) + (1|Stimulus)",
  var = "Attractive", fill = "#F44336"
)
rez_gl <- make_model(filter(df, Stimulus_Interest == TRUE),
  formula = "Sex / poly(Beauty, 2) + Trustworthy + Familiar + (1|Participant) + (1|Stimulus)",
  var = "Beauty", fill = "#E91E63"
)
rez_tr <- make_model(filter(df, Stimulus_Interest == TRUE),
  formula = "Sex / poly(Trustworthy, 2) + Beauty + Familiar + (1|Participant) + (1|Stimulus)",
  var = "Trustworthy", fill = "#4CAF50"
)
rez_fa <- make_model(filter(df, Stimulus_Interest == TRUE),
  formula = "Sex / poly(Familiar, 2) + Beauty + Trustworthy + (1|Participant) + (1|Stimulus)",
  var = "Familiar", fill = "#2196F3"
)
```

### Attractiveness

```{r message=FALSE, warning=FALSE, cache=cache}
parameters::parameters(rez_at$model_belief, effects = "fixed", keep = "Attractive") |> 
  display()
performance::performance(rez_at$model_belief, metrics = c("R2")) |> 
  display()
performance::icc(rez_at$model_belief, by_group = TRUE)  |> 
  display()
parameters::parameters(rez_at$model_confidence, effects = "fixed", keep = "Attractive")  |> 
  display()

rez_at$p
```

### Beauty

```{r message=FALSE, warning=FALSE, cache=cache}
parameters::parameters(rez_gl$model_belief, effects = "fixed", keep = "Beauty")|> 
  display()
performance::performance(rez_gl$model_belief, metrics = c("R2")) |> 
  display()
performance::icc(rez_gl$model_belief, by_group = TRUE)|> 
  display()
parameters::parameters(rez_gl$model_confidence, effects = "fixed", keep = "Beauty") |> 
  display()

rez_gl$p
```

### Trustworthiness

```{r message=FALSE, warning=FALSE, cache=cache}
parameters::parameters(rez_tr$model_belief, effects = "fixed", keep = "Trustworthy") |> 
  display()
performance::performance(rez_tr$model_belief, metrics = c("R2")) |> 
  display()
performance::icc(rez_tr$model_belief, by_group = TRUE) |> 
  display()
parameters::parameters(rez_tr$model_confidence, effects = "fixed", keep = "Trustworthy") |> 
  display()

rez_tr$p
```

### Familiarity

```{r message=FALSE, warning=FALSE, cache=cache}
parameters::parameters(rez_fa$model_belief, effects = "fixed", keep = "Familiar") |> 
  display()
performance::performance(rez_fa$model_belief, metrics = c("R2")) |> 
  display()
performance::icc(rez_fa$model_belief, by_group = TRUE) |> 
  display()
parameters::parameters(rez_fa$model_confidence, effects = "fixed", keep = "Familiar") |> 
  display()

rez_fa$p
```

### Cross-Validate with Normmative Scores

```{r make_models_norms, message=FALSE, warning=FALSE, fig.width=fig.width, fig.height=fig.width, cache=cache}
rez_at_norm <- filter(df, Stimulus_Interest == TRUE) |> 
  mutate(Norms_Attractive = normalize(Norms_Attractive)) |> 
  make_model(
    formula = "Sex / poly(Norms_Attractive, 2) + (1|Participant) + (1|Stimulus)",
    var = "Norms_Attractive", fill = "#F44336"
)

parameters::parameters(rez_at_norm$model_belief, effects = "fixed", keep = "Attractive") |> 
  display()
rez_at_norm$p


rez_tr_norm <- filter(df, Stimulus_Interest == TRUE) |> 
  mutate(Norms_Trustworthy = normalize(Norms_Trustworthy)) |> 
  make_model(
    formula = "Sex / poly(Norms_Trustworthy, 2) + (1|Participant) + (1|Stimulus)",
    var = "Norms_Trustworthy", fill = "#4CAF50"
)

parameters::parameters(rez_tr_norm$model_belief, effects = "fixed", keep = "Trustworthy") |> 
  display()
rez_tr_norm$p
```

## Interaction with Self-Attractiveness

```{r message=FALSE, warning=FALSE}
cor_test(dfsub, "SelfAttractiveness1", "SelfAttractiveness2")

df$Self_Attractiveness <- rowMeans(df[c("SelfAttractiveness1", "SelfAttractiveness2")])
```

```{r message=FALSE, warning=FALSE, cache=cache}
m_real <- glmmTMB::glmmTMB(Belief ~ Sex / (poly(Attractive, 2) * Self_Attractiveness) + (1 | Participant) + (1 | Stimulus),
  data = filter(df, Stimulus_Interest == TRUE),
  family = "binomial"
)
parameters::parameters(m_real, effects = "fixed", keep = "Self_Attractiveness") |> 
  display()


m_real <- glmmTMB::glmmTMB(Belief ~ Sex / (poly(Beauty, 2) * Self_Attractiveness) + Trustworthy + Familiar + (1 | Participant) + (1 | Stimulus),
  data = filter(df, Stimulus_Interest == TRUE),
  family = "binomial"
)
parameters::parameters(m_real, effects = "fixed", keep = "Self_Attractiveness") |> 
  display()
```

## Inter-Individual Correlates {.tabset}

```{r message=FALSE, warning=FALSE}
plot_interindividual <- function(m_real, m_conf, var = "IPIP6_HonestyHumility", fill = "#D81B60") {
  y_real <- estimate_relation(m_real, at = c(var), length = 21)
  y_conf <- estimate_relation(m_conf, at = c(var, "Belief"), length = 21)
  
  y_conf <- y_conf |>
    mutate_at(c("Predicted", "CI_low", "CI_high"), function(x) ifelse(y_conf$Belief == "Real", datawizard::rescale(x, range = c(0, 1), to = c(0.5, 1)), datawizard::rescale(x, range = c(1, 0), to = c(0, 0.5))))

  # Significance
  mid <- max(y_conf[[var]])-diff(range(y_conf[[var]])) / 2
  sig1 <- data.frame(x = mid, y = y_real[c(11), "Predicted"] + 0.065,
                     p = parameters::parameters(m_real, effects = "fixed", keep = var)$p)
  sig1$label <- ifelse(sig1$p > .05 & sig1$p < .1, format_p(sig1$p), format_p(sig1$p, stars_only = TRUE))
  sig2 <- data.frame(x = mid, y = y_conf[c(11, 31), "Predicted"] + c(-0.065, 0.065),
                     p = parameters::parameters(m_conf, effects = "fixed", keep = var)$p,
                     Belief = y_conf[c(11, 31), "Belief"])
  sig2$label <- ifelse(sig2$p > .05 & sig2$p < .1, format_p(sig2$p), format_p(sig2$p, stars_only = TRUE))
  
  # Data
  dat <- insight::get_data(m_conf) |> 
                  group_by(Participant, Belief) |> 
                  data_select(c("Participant", "Belief", var, "Belief_Confidence")) |> 
                  mean_qi(.width = 0.5) |> 
    mutate(Belief_Confidence = ifelse(Belief == "Real", datawizard::rescale(Belief_Confidence, range = c(0, 1), to = c(0.5, 1)), datawizard::rescale(Belief_Confidence, range = c(1, 0), to = c(0, 0.5))))
  
  
  # Plot
  p <- df |>
    ggplot(aes_string(x = var, y = "Real")) +
    stat_density_2d(data=filter(df, Belief=="Real"), aes(fill = after_stat(density)), geom = "raster", contour = FALSE, alpha=0.5) +
    scale_fill_gradientn(colors = c("white", "#4CAF50"), guide = "none") +
    ggnewscale::new_scale_fill() +
    stat_density_2d(data=filter(df, Belief=="Fake"), aes(fill = after_stat(density)), geom = "raster", contour = FALSE, alpha=0.5) +
    scale_fill_gradientn(colors = c("white", "#F44336"), guide = "none") +
    ggnewscale::new_scale_fill() +
    geom_hline(yintercept = 0.5, linetype = "dotted") +
    geom_point2(data=dat, aes(y = Belief_Confidence, color = Belief), alpha = 0.25, size = 4) +
    geom_ribbon(data = y_conf, aes(y = Predicted, ymin = CI_low, ymax = CI_high, fill = Belief), alpha = 1 / 6) +
    geom_line(data = y_conf, aes(y = Predicted, group = Belief, color = Belief)) +
    geom_ribbon(data = y_real, aes(y = Predicted, ymin = CI_low, ymax = CI_high), alpha = 1 / 6) +
    geom_line(data = y_real, aes(y = Predicted), size=1) +
    geom_text(data = sig1, aes(y = y, x = x, label = label), size = ifelse(sig1$p < .05, 8, 3.5)) +
    geom_text(data = sig2, aes(y = y, x = x, label = label), size = ifelse(sig2$p < .05, 8, 3.5)) +
    scale_color_manual(values = c("Real" = "#4CAF50", "Fake" = "#F44336")) +
    scale_fill_manual(values = c("Real" = "#4CAF50", "Fake" = "#F44336")) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0), breaks = c(0, 0.25, 0.5, 0.75, 1), labels = c("Fake", "25%", "50%", "75%", "Real")) +
    labs(y = "Simulation Monitoring") +
    guides(fill = guide_legend(override.aes = list(alpha = 1))) +
    theme_modern(axis.title.space = 5) +
    ggside::geom_xsidedensity(data=dat, fill = fill, color = NA) +
    ggside::geom_ysidedensity(data=dat, aes(fill = Belief, y=Belief_Confidence), color = NA) +
    ggside::theme_ggside_void() +
    ggside::scale_ysidex_continuous(expand = c(0, 0)) +
    ggside::scale_xsidey_continuous(expand = c(0, 0))

  p
}
```

```{r message=FALSE, warning=FALSE}
make_correlation <- function(x, y) {
  cor <- correlation::correlation(x,
    y,
    bayesian = TRUE,
    bayesian_prior = "medium.narrow",
    sort = TRUE
  ) |>
    datawizard::data_remove(c("ROPE_Percentage"))
  cor$`BF (Spearman)` <- format_bf(
    correlation::correlation(
      x, y,
      bayesian = TRUE,
      ranktransform = TRUE,
      bayesian_prior = "medium.narrow"
    )$BF,
    name = NULL, stars = TRUE
  )
  cor |>
    arrange(desc(BF))
}
```

```{r message=FALSE, warning=FALSE, cache=cache}
analyze_interindividual <- function(df, questionnaire = "IPIP6_") {
  param_real <- data.frame()
  param_conf <- data.frame()
  for(var in names(select(df, starts_with(questionnaire)))) {
    m_real <- glmmTMB::glmmTMB(as.formula(paste0("Belief ~ ", var)), 
                               data=datawizard::standardise(df, select=var), family = "binomial")
    param_real <- rbind(param_real, parameters::parameters(m_real, effects="fixed")[2, ])
    
    m_conf <- glmmTMB::glmmTMB(as.formula(paste0("Belief_Confidence ~ Belief / ", var)), 
                             
                               data=datawizard::standardise(df, select=var), 
                             family = glmmTMB::beta_family())
  
    param_conf <- rbind(param_conf, parameters::parameters(m_conf, effects="fixed")[3:4, ])
  }
  
  param_real <- param_real |> 
    mutate(Parameter = str_remove(Parameter, questionnaire)) |> 
    select(-SE)
  param_conf <- param_conf |> 
    tidyr::separate("Parameter", into = c("Belief", "Dimension"), sep = ":") |> 
    mutate(Belief = str_remove(Belief, "Belief"),
           Dimension = str_remove(Dimension, questionnaire)) |> 
    select(-SE)
  list(param_real, param_conf)
}
```

### IPIP-6

```{r ipip, message=FALSE, warning=FALSE, cache=cache}
f <- paste0("(",paste(names(select(df, starts_with("IPIP"))), collapse = " + "), 
            ") + (1|Participant) + (1|Stimulus)")


m_real <- glmmTMB::glmmTMB(as.formula(paste0("Belief ~ ", f)), data=df, family = "binomial")

parameters::parameters(m_real, effects="fixed", exponentiate = TRUE) |> 
  display()


m_conf <- glmmTMB::glmmTMB(as.formula(paste0("Belief_Confidence ~ Belief / ", f)), 
                           data=df, 
                           family = glmmTMB::beta_family())

parameters::parameters(m_conf, effects="fixed") |> 
  display()

p_ipip <- plot_interindividual(m_real, m_conf, var = "IPIP6_HonestyHumility", fill = "#00BCD4") + labs(x = "Honesty-Humility")
p_ipip
```

```{r message=FALSE, warning=FALSE, cache=cache}
sr <- c("Confidence_Fake", "Confidence_Real", "n_Real")

r <- make_correlation(dfsub[sr], select(dfsub, starts_with("IPIP")))
filter(r, BF > 1)
```

### Narcissism

```{r narcissism, message=FALSE, warning=FALSE, cache=cache}
f <- paste0("(",paste(names(select(df, starts_with("FFNI"))), collapse = " + "), 
            ") + (1|Participant) + (1|Stimulus)")


m_real <- glmmTMB::glmmTMB(as.formula(paste0("Belief ~ ", f)), data=df, family = "binomial")

parameters::parameters(m_real, effects="fixed", exponentiate = TRUE) |> 
  display()


m_conf <- glmmTMB::glmmTMB(as.formula(paste0("Belief_Confidence ~ Belief / ", f)), 
                           data=df, 
                           family = glmmTMB::beta_family())

parameters::parameters(m_conf, effects="fixed") |> 
  display()

p_ffni1 <- plot_interindividual(m_real, m_conf, var = "FFNI_AcclaimSeeking", fill = "#FFC107") + labs(x = "Narcissism (Acclaim Seeking)")
p_ffni1

p_ffni2 <- plot_interindividual(m_real, m_conf, var = "FFNI_Authoritativeness", fill = "#FF5722") + labs(x = "Narcissism (Authoritativeness)")
p_ffni2

p_ffni3 <- plot_interindividual(m_real, m_conf, var = "FFNI_Manipulativeness", fill = "#FF9800") + labs(x = "Narcissism (Manipulativeness)")
p_ffni3
```

```{r message=FALSE, warning=FALSE, cache=cache}
r <- make_correlation(dfsub[sr], select(dfsub, starts_with("FFNI_")))
filter(r, BF > 1)
```

```{r message=FALSE, warning=FALSE, cache=cache}
cor_test(dfsub, "FFNI_Authoritativeness", "IPIP6_HonestyHumility")
# cor_test(dfsub, "FFNI_ThrillSeeking", "IPIP6_HonestyHumility")
```

### Social Anxiety

```{r message=FALSE, warning=FALSE, cache=cache}
f <- paste0("(",paste(names(select(df, starts_with("Social_"))), collapse = " + "), 
            ") + (1|Participant) + (1|Stimulus)")


m_real <- glmmTMB::glmmTMB(as.formula(paste0("Belief ~ ", f)), data=df, family = "binomial")

parameters::parameters(m_real, effects="fixed", exponentiate = TRUE) |> 
  display()


m_conf <- glmmTMB::glmmTMB(as.formula(paste0("Belief_Confidence ~ Belief / ", f)), 
                           data=df, 
                           family = glmmTMB::beta_family())

parameters::parameters(m_conf, effects="fixed") |> 
  display()

# p_social <- plot_interindividual(m_real, m_conf, var = "Social_Phobia", fill = "#E040FB") + labs(x = "Social Phobia")
# p_social 
```

```{r message=FALSE, warning=FALSE, cache=cache}
r <- make_correlation(dfsub[sr], select(dfsub, starts_with("Social_")))
filter(r, BF > 1)
```

### Intolerance to Uncertainty

```{r ius, message=FALSE, warning=FALSE, cache=cache}
f <- paste0("(",paste(names(select(df, starts_with("IUS_"))), collapse = " + "), 
            ") + (1|Participant) + (1|Stimulus)")


m_real <- glmmTMB::glmmTMB(as.formula(paste0("Belief ~ ", f)), data=df, family = "binomial")

parameters::parameters(m_real, effects="fixed", exponentiate = TRUE) |> 
  display()


m_conf <- glmmTMB::glmmTMB(as.formula(paste0("Belief_Confidence ~ Belief / ", f)), 
                           data=df, 
                           family = glmmTMB::beta_family())

parameters::parameters(m_conf, effects="fixed") |> 
  display()
```

```{r message=FALSE, warning=FALSE, cache=cache}
r <- make_correlation(dfsub[sr], select(dfsub, starts_with("IUS_")))
filter(r, BF > 1)
```

### Paranoid Beliefs

```{r gpts, message=FALSE, warning=FALSE, cache=cache}
f <- paste0("(",paste(names(select(df, starts_with("GPTS_"))), collapse = " + "), 
            ") + (1|Participant) + (1|Stimulus)")


m_real <- glmmTMB::glmmTMB(as.formula(paste0("Belief ~ ", f)), data=df, family = "binomial")

parameters::parameters(m_real, effects="fixed", exponentiate = TRUE) |> 
  display()


m_conf <- glmmTMB::glmmTMB(as.formula(paste0("Belief_Confidence ~ Belief / ", f)), 
                           data=df, 
                           family = glmmTMB::beta_family())

parameters::parameters(m_conf, effects="fixed") |> 
  display()

p_gpts1 <- plot_interindividual(m_real, m_conf, var = "GPTS_Persecution", fill = "#673AB7") + labs(x = "Paranoid Thoughts (Persecution)")
p_gpts1
```

```{r message=FALSE, warning=FALSE, cache=cache}
r <- make_correlation(dfsub[sr], select(dfsub, starts_with("GPTS_")))
filter(r, BF > 1)
```

### AI

```{r ai, message=FALSE, warning=FALSE, cache=cache}
rez <- parameters::n_factors(select(dfsub, starts_with("AI")))
plot(rez)

efa <- parameters::factor_analysis(select(dfsub, starts_with("AI")), n = 3, rotation = "varimax", sort = TRUE)
efa
dfsub <- predict(efa, names = c("AI_Enthusiasm", "AI_Realness", "AI_Danger")) |>
  cbind(dfsub)
df <- predict(efa, newdata=df, names = c("AI_Enthusiasm", "AI_Realness", "AI_Danger")) |> 
  cbind(df)
```

```{r message=FALSE, warning=FALSE, cache=cache}
f <- paste0("(AI_Enthusiasm + AI_Realness + AI_Danger) + (1|Participant) + (1|Stimulus)")


m_real <- glmmTMB::glmmTMB(as.formula(paste0("Belief ~ ", f)), data=df, family = "binomial")

parameters::parameters(m_real, effects="fixed", exponentiate = TRUE) |> 
  display()


m_conf <- glmmTMB::glmmTMB(as.formula(paste0("Belief_Confidence ~ Belief / ", f)), 
                           data=df, 
                           family = glmmTMB::beta_family())

parameters::parameters(m_conf, effects="fixed") |> 
  display()


p_ai <- plot_interindividual(m_real, m_conf, var = "AI_Enthusiasm", fill = "#607D8B") + 
  labs(x = "Enthusiasm about AI technology")
p_ai 
```

```{r message=FALSE, warning=FALSE, cache=cache}
r <- make_correlation(dfsub[sr], select(dfsub, AI_Enthusiasm, AI_Realness, AI_Danger))
filter(r, BF > 1)
```

## Figures

```{r message=FALSE, warning=FALSE}
fig1a <- (rez_at$p +
  theme(axis.text.x = element_blank()) +
  labs(x = "Attractiveness") |
  rez_gl$p +
    labs(x = "Beauty") +
    theme(
      axis.text.x = element_blank(),
      axis.title.y = element_blank(),
      axis.text.y = element_blank()
    )
) /
  (rez_tr$p +
    labs(x = "Trustworthiness") |
    rez_fa$p +
      labs(x = "Familiarity") +
      theme(
        axis.text.y = element_blank(),
        axis.title.y = element_blank()
      )
  ) +
  plot_annotation(title = "Determinants of Reality Beliefs", theme = theme(plot.title = element_text(face = "bold", hjust = 0.5))) +
  plot_layout(guides = "collect") &
  theme(legend.title = element_text(face = "bold"))

fig <- wrap_elements(fig1a) /
  wrap_elements(
    # ((p_ffni1 / p_ipip) | (p_ffni2 / p_social) | (p_ffni3 / p_ai)) + 
    ((p_ffni1 / p_ipip) | (p_ffni3 / p_gpts1) | (p_ffni2 / p_ai)) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Personality Correlates of Simulation Monitoring Tendencies", theme = theme(plot.title = element_text(face = "bold", hjust = 0.5))) &
  theme(legend.title = element_text(face = "bold")) 
  ) +
  plot_layout(heights = c(1.1, 0.9)) 

ggsave("figures/Figure2.png", fig, width=fig.height * 1.8, height=fig.width * 1.5)
```

# References
